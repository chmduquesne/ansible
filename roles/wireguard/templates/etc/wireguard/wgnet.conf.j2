#jinja2: lstrip_blocks: True
# {{ ansible_managed }}

[Interface]
PrivateKey = {{ conf.privkey }}
{% if 'listenport' in conf %}
ListenPort = {{ conf.listenport }}
{% endif %}
{% for peer in peers %}
    {% set peervars = hostvars[peer] %}
    {% if wgnet in peervars.wireguard %}
        {% set peerconf = peervars.wireguard[wgnet] %}

[Peer]
PublicKey = {{ peerconf.pubkey }}
        {% if 'allowed_ips' in peerconf %}
AllowedIPs = {{ peerconf.allowed_ips }}
        {% endif %}
        {% if 'public_addr' in peerconf %}
Endpoint = {{ peerconf.public_addr }}:{{ peerconf.listenport }}
PersistentKeepalive = 20
        {% endif %}
    {% endif %}
{% endfor %}
