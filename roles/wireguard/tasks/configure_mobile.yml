---

- name: "collect the private key of {{ peername }}"
  set_fact:
    _privkey: "{{ wireguard[wgnet].peers[peername].privkey | default('<your private key here>') }}"

- name: "adjusting {{ peername }} config variables"
  set_fact:
    _conf: "{{ wireguard[wgnet]|combine({'privkey': _privkey})|auto_assign_ips(peername)|remove_peer(peername) }}"
    _conf_clean: {}

- name: "removing the fields that are irrelevant for mobile devices"
  set_fact:
    _conf_clean: "{{ _conf|combine({item.key: item.value}) }}"
  with_dict: "{{ _conf }}"
  when: (item.key not in ('listenport', 'table', 'preup', 'postup', 'predown', 'postdown'))

- name: "adding user configured mobile fields"
  set_fact:
    _conf: "{{ _conf_clean|combine(wireguard_mobile_parameters[wgnet]|default(dict())) }}"

- name: setting file name
  set_fact:
    template_dest: "{{ wireguard_mobile_conf_dir }}/{{ wgnet }}.{{ peername }}.conf"

- name: "saving old conf"
  set_fact:
    old_conf: "{{ conf }}"
    conf: "{{ _conf }}"

- name: "create {{ peername }} config"
  template:
    src: templates/etc/wireguard/wgnet.conf.j2
    dest: "{{ template_dest }}"
  delegate_to: 127.0.0.1
  become: false
  vars:
    - conf: _conf

- name: "restoring old conf"
  set_fact:
    conf: "{{ old_conf }}"
