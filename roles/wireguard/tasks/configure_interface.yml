---
- name: enable ipv6 forwarding for all interfaces
  sysctl: name=net.ipv6.conf.all.forwarding value=1
  when: ('in_gw' in conf) or ('out_gw' in conf)

- name: enable ipv6 forwarding by default
  sysctl: name=net.ipv6.conf.default.forwarding value=1
  when: ('in_gw' in conf) or ('out_gw' in conf)

- name: enable ipv4 forwarding for all interfaces
  sysctl: name=net.ipv4.ip_forward value=1
  when: ('in_gw' in conf) or ('out_gw' in conf)

- name: get first ipv6 subnet
  set_fact:
    subnet: "{{ conf.auto_assign_ips | ipv6 | first }}"

- name: set addresses
  set_fact:
    post_up: "{{ post_up | default([]) }} + ['ip address add {{ item }} dev {{ wgnet }}']"
  with_items: "{{ conf.address }}"

- name: routing dedicated subnet from out_gw to in_gw
  set_fact:
    post_up: "{{ post_up | default([]) }} + ['ip route add {{ conf.gw.routed_inet6.prefix }}::/{{ conf.gw.routed_inet6.mask }} via {{ conf.pubkey | gen_ip(subnet=subnet) }} dev {{ wgnet }}']"
  when: is_out_gw

# Generate a table number from the interface name.
# see filter_plugins/gen_uint32.py
- set_fact:
    wgtable: "{{ wgnet | gen_uint32 }}"

- name: routing all wlan traffic to wireguard
  set_fact:
    post_up2:
      - ip -6 route flush table {{ wgtable }}
      - ip -4 route flush table {{ wgtable }}
      - ip -6 route add default dev {{ wgnet }} table {{ wgtable }}
      - ip -4 route add default dev {{ wgnet }} table {{ wgtable }}
      - ip -6 rule add iif {{ conf.gw.in.interface }} lookup {{ wgtable }}
      - ip -4 rule add iif {{ conf.gw.in.interface }} lookup {{ wgtable }}
  when: is_in_gw

- set_fact:
    post_up: "{{ post_up }} + {{ post_up2 | default([]) }}"

- name: set general settings
  set_fact:
    interface:
      device: "{{ wgnet }}"
      family: inet6
      method: manual
      pre-up:
        - ip link add dev {{ wgnet }} type wireguard
        - wg setconf {{ wgnet }} /etc/wireguard/{{ wgnet }}.conf
        - ip link set mtu {{ conf.mtu | default(1420) }} dev {{ wgnet }}
      up:
        - ip link set dev {{ wgnet }} up
      post-up: "{{ post_up }}"
      down:
        - ip link del dev {{ wgnet }}

- name: adding interface suggestion
  set_fact:
    wireguard_suggested_interfaces: "{{ wireguard_suggested_interfaces | default([]) }} + [ interface ]"
