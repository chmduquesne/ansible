---
- set_fact:
    peers: []

- name: collect peers
  set_fact:
    peers: "{{ peers + [ item ] }}"
  with_items:
    "{{ other_wireguard_hosts }}"
  when:
    - net in hostvars[item].wireguard

- name: set creation command
  set_fact:
    net_pre_up: [ "ip link add dev $IFACE type wireguard" ]

- name: set add peer command
  set_fact:
    net_pre_up: "{{ net_pre_up }} + [ 'ip address add {{ wireguard[net].inet6_addr }} peer {{ hostvars[item].wireguard[net].inet6_addr }} dev {{ net }}' ]"
  with_items:
    "{{ peers }}"

- name: set setconf command
  set_fact:
    net_pre_up: "{{ net_pre_up }} + [ 'wg setconf $IFACE /etc/wireguard/${IFACE}.conf' ]"

- name: set up commands
  set_fact:
    net_up:
      - ip link set up dev $IFACE

- name: collect routing mode
  set_fact:
    mode: public
  when:
    - wireguard[net].public is defined
    - wireguard[net].public

- name: collect routing mode
  set_fact:
    mode: router
  when:
    - wireguard[net].router is defined

- name: manage routing
  include_tasks: "configure_routing_{{ mode }}.yml"

- name: set general settings
  set_fact:
    net_settings:
      device: "{{ net }}"
      family: inet6
      method: manual
      pre-up: "{{ net_pre_up }}"
      up: "{{ net_up }}"
      post-up: "{{ net_post_up }}"
      down:
        - ip link del dev $IFACE

- name: add in network interfaces
  set_fact:
    network_interfaces_interfaces: "{{ network_interfaces_interfaces + [ net_settings ] }}"
  when: network_interfaces_interfaces is defined

- debug:
    var: network_interfaces_interfaces
  when: network_interfaces_interfaces is defined
