---
- name: enable ipv6 forwarding for all interfaces
  sysctl: name=net.ipv6.conf.all.forwarding value=1

- name: enable ip forwarding at post-up
  set_fact:
    net_post_up:
      - "echo 1 > /proc/sys/net/ipv6/conf/{{ wgnet }}/forwarding"
      - "echo 1 > /proc/sys/net/ipv4/ip_forward"

- name: set routes at post-up
  set_fact:
    net_post_up: "{{ net_post_up }} + [ 'ip route add {{ hostvars[item].wireguard[wgnet].in_gw.inet6_prefix }}::/{{ hostvars[item].wireguard[wgnet].in_gw.inet6_mask }} via {{ inet6_auto_addr[item] }} dev {{ wgnet }}' ]"
  with_items:
    "{{ peers }}"
  when:
    - hostvars[item].wireguard[wgnet].in_gw is defined
    - hostvars[item].wireguard[wgnet].in_gw.inet6_prefix is defined
