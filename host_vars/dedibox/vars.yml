---
# No longer Necessary after users/sudo are setup
#ansible_become_user: root
#ansible_become_method: su
#ansible_become_pass: "{{ vault_ansible_become_pass }}"
#ansible_ssh_pass: "{{ vault_ansible_ssh_pass }}"
#ansible_user: "{{ vault_ansible_user }}"

ansible_host: "{{ vault_ansible_host }}"

dhclient_config:
 - option rfc3442-classless-static-routes code 121 = array of unsigned integer 8;
 - send host-name = gethostname();
 - |
   request subnet-mask, broadcast-address, time-offset, routers,
           domain-name, domain-name-servers, domain-search, host-name,
           dhcp6.name-servers, dhcp6.domain-search, dhcp6.fqdn, dhcp6.sntp-servers,
           netbios-name-servers, netbios-scope, interface-mtu,
           rfc3442-classless-static-routes, ntp-servers;
 - |
   interface "enp0s20" {
      send dhcp6.client-id {{ vault_dhcp6_clientid }};
   }

network_interfaces_manage_devices: true
network_interfaces_interfaces:
  - device: enp0s20
    family: inet
    method: dhcp
  - device: enp0s20
    family: inet6
    method: dhcp
    request_prefix: 1
    accept_ra: 2

wireguard_override:
  wg0:
    privkey: "{{ vault_wg0_privkey }}"
    listenport: 500
    out_gw: enp0s20
    unbound_records: True
    dns: False

wireguard: "{{ wireguard_default|combine(wireguard_override, recursive=True) }}"

wireguard_generate_mobile: true
wireguard_mobile_conf_dir: "wg_configs"
wireguard_mobile_parameters:
  wg0:
    dns: "{{ wireguard_default.wg0.dns }}"

iptables_custom_rules:
  - name: "wg0_dns"
    rules: |
      -A INPUT -i wg0 -p tcp -m tcp --dport 53 -m conntrack --ctstate NEW -j ACCEPT
      -A INPUT -i wg0 -p udp -m udp --dport 53 -m conntrack --ctstate NEW -j ACCEPT
  - name: "haproxy"
    rules: |
      -A INPUT -p tcp -m tcp --dport 80 -m conntrack --ctstate NEW -j ACCEPT
      -A INPUT -p tcp -m tcp --dport 443 -m conntrack --ctstate NEW -j ACCEPT

ip6tables_custom_rules: "{{ iptables_custom_rules }}"

unbound_unbound_conf:
  - |
    server:
      interface: ::0
      max-udp-size: 3072
      access-control: ::0/0 refuse
      access-control: ::1 allow
      access-control: {{ wireguard.wg0.auto_assign_ips.0 }} allow
      access-control: {{ wireguard.wg0.auto_assign_ips.1 }} allow
      harden-referral-path: yes
      unwanted-reply-threshold: 10000000
      val-permissive-mode: yes
      val-log-level: 1
      prefetch-key: yes
      cache-min-ttl: 1800
      cache-max-ttl: 14400
      prefetch: yes
      include: /etc/unbound/records.d/*.conf

haproxy_install:
  - socat
haproxy_global_chroot: /var/lib/haproxy
haproxy_frontend:
  - name: http
    mode: http
    description: Front-end for all HTTP traffic
    bind:
      - listen: ":80"
    default_backend: github
haproxy_backend:
  - name: github
    description: github
    mode: http
    balance: roundrobin
    server:
      - name: github0
        listen: chmduquesne.github.io:443
        param:
          - check
          - ssl
          - verify none

host_roles:
  - common
  - reallyenglish.dhclient
  - chmduquesne.network_interfaces
  - chmduquesne.wireguard
  - unbound
  - oefenweb.haproxy

